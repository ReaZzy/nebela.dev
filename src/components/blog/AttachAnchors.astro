---

---

<script>
  let abortController = new AbortController();

  function generateId(text: string): string {
    return text
      .toLowerCase()
      .replace(/[^a-z0-9\s-]/g, "")
      .trim()
      .replace(/\s+/g, "-");
  }

  function setupHeadingAnchors() {
    const clearActiveHeadings = () => {
      document
        .querySelectorAll(".prose .active-heading")
        .forEach((h) => h.classList.remove("active-heading"));
    };

    const activateHeading = (target: Element) => {
      clearActiveHeadings();
      target.classList.add("active-heading");
      target.scrollIntoView({ behavior: "smooth", block: "start" });
    };

    document
      .querySelectorAll<HTMLElement>(".prose h2, .prose h3")
      .forEach((heading) => {
        if (heading.classList.contains("heading-with-anchor")) return;

        const text = heading.textContent || "";
        const id = heading.id || generateId(text);

        heading.id = id;
        heading.classList.add("heading-with-anchor");
        heading.style.cursor = "pointer";

        const anchor = document.createElement("a");
        anchor.href = `#${id}`;
        anchor.className = "heading-anchor";
        anchor.setAttribute("aria-label", `Link to ${text}`);
        anchor.textContent = "#";
        heading.appendChild(anchor);

        heading.addEventListener(
          "click",
          (e) => {
            e.preventDefault();
            e.stopPropagation();
            activateHeading(heading);
            window.history.replaceState(null, "", `#${id}`);
          },
          { signal: abortController.signal }
        );
      });

    window.addEventListener(
      "hashchange",
      () => {
        const hash = window.location.hash;
        if (hash) {
          const target = document.querySelector(hash);
          if (target) activateHeading(target);
        } else {
          clearActiveHeadings();
        }
      },
      { signal: abortController.signal }
    );

    const hash = window.location.hash;
    if (hash) {
      const target = document.querySelector(hash);
      if (target) activateHeading(target);
    }
  }

  setupHeadingAnchors();

  document.addEventListener("astro:before-swap", () => {
    abortController.abort();
    abortController = new AbortController();
  });

  document.addEventListener("astro:page-load", setupHeadingAnchors);
</script>
